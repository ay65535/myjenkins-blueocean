#!/bin/bash

## Parameters

# if 1st parameter is not set, use the value of PROXY, if it is not set, use the value of HTTP_PROXY/http_proxy.
PROXY=${1-${PROXY:-${HTTP_PROXY:-$http_proxy}}}
# if 2nd parameter is not set, use the value of NO_PROXY/no_proxy.
NO_PROXY=${2-$NO_PROXY:-${no_proxy}}
# if 3rd parameter is not set, use the value of JENKINS_AGENT_SSH_PUBKEY, if it is not set, use the content of ~/.ssh/jenkins_agent_key.pub.
JENKINS_AGENT_SSH_PUBKEY=${3-${JENKINS_AGENT_SSH_PUBKEY:-$(cat ~/.ssh/jenkins_agent_key.pub)}}

## Build environment variables.

if [ -n "$PROXY" ]; then
  COMMENT_PROXY_SEC=
else
  COMMENT_PROXY_SEC=#
  PROXY=http://proxy.example.com:8080
fi

PROXY_SERVER=${PROXY//http*:\/\//}
PROXY_HOST=${PROXY_SERVER%%:*}
PROXY_PORT=${PROXY_SERVER##*:}
JAVA_TOOL_OPTIONS="-Dhttp.proxyHost=$PROXY_HOST -Dhttp.proxyPort=$PROXY_PORT -Dhttps.proxyHost=$PROXY_HOST -Dhttps.proxyPort=$PROXY_PORT"

if [ -n "$NO_PROXY" ]; then
  COMMENT_NOPROXY_SEC=
  no_proxy=$NO_PROXY
  NO_PROXY_PIPE=$(echo "$NO_PROXY" | tr ',' '|')
  JAVA_TOOL_OPTIONS="${JAVA_TOOL_OPTIONS} -Dhttp.nonProxyHosts='${NO_PROXY_PIPE}'"
else
  COMMENT_NOPROXY_SEC=#
  NO_PROXY=127.0.0.1,localhost
  no_proxy=$NO_PROXY
  NO_PROXY_PIPE=$(echo "$NO_PROXY" | tr ',' '|')
  JAVA_TOOL_OPTIONS="${JAVA_TOOL_OPTIONS} -Dhttp.nonProxyHosts='${NO_PROXY_PIPE}'"
fi

if [ -n "$COMMENT_PROXY_SEC" ] || [ -n "$COMMENT_NOPROXY_SEC" ]; then
  COMMENT_JAVA_TOOL_OPTIONS_SEC=
else
  COMMENT_JAVA_TOOL_OPTIONS_SEC=#
fi

if [ -n "$JENKINS_AGENT_SSH_PUBKEY" ]; then
  COMMENT_JENKINS_AGENT_SSH_PUBKEY_SEC=
else
  COMMENT_JENKINS_AGENT_SSH_PUBKEY_SEC=#
fi

## Print environment variables.

cat <<EOF
# This file is generated by \`$0 $*\`.

# https://www.jenkins.io/doc/book/installing/docker/
JENKINS_VERSION=2.387.3

VOLUME_ROOT=./data

HOST_UID=$(id -u)
HOST_GID=$(id -g)

# TRUST_HOST=updates.jenkins.io,mirrors.jenkins.io

${COMMENT_PROXY_SEC}PROXY=$PROXY
${COMMENT_PROXY_SEC}PROXY_HOST=$PROXY_HOST
${COMMENT_PROXY_SEC}PROXY_PORT=$PROXY_PORT
${COMMENT_PROXY_SEC}PROXY_SERVER=$PROXY_SERVER

${COMMENT_PROXY_SEC}http_proxy=$PROXY
${COMMENT_PROXY_SEC}https_proxy=$PROXY
${COMMENT_PROXY_SEC}ftp_proxy=$PROXY
${COMMENT_PROXY_SEC}all_proxy=$PROXY

${COMMENT_PROXY_SEC}HTTP_PROXY=$PROXY
${COMMENT_PROXY_SEC}HTTPS_PROXY=$PROXY
${COMMENT_PROXY_SEC}FTP_PROXY=$PROXY
${COMMENT_PROXY_SEC}ALL_PROXY=$PROXY

${COMMENT_NOPROXY_SEC}no_proxy=$no_proxy
${COMMENT_NOPROXY_SEC}NO_PROXY=$NO_PROXY

${COMMENT_JAVA_TOOL_OPTIONS_SEC}JAVA_TOOL_OPTIONS=$JAVA_TOOL_OPTIONS

# JENKINS_AGENT_SSH_PUBKEY=\$(cat ~/.ssh/jenkins_agent_key.pub) && echo \$JENKINS_AGENT_SSH_PUBKEY
${COMMENT_JENKINS_AGENT_SSH_PUBKEY_SEC}JENKINS_AGENT_SSH_PUBKEY=$JENKINS_AGENT_SSH_PUBKEY
EOF
